# Задача 1.5: Настройка базового DataService

## Подготовка
- Внимательно изучи документы `bizlevel-concept-updated.md` и `status.md` для полного понимания архитектуры проекта и текущего статуса разработки.
- Ознакомься с реализацией из задач 1.1-1.4.
- Изучи раздел "Оптимизация запросов" в концепции проекта.

## Описание задачи
Требуется разработать сервис для централизованного доступа к данным (`DataService`), который будет обеспечивать эффективное взаимодействие с Firestore и Firebase Storage. Сервис должен поддерживать кэширование, пагинацию и оптимизацию запросов, а также предоставлять унифицированный интерфейс для всех репозиториев.

Шаги:
1. Создать реализацию `FirestoreDataService` в директории `src/infrastructure/services/`:
   - Реализовать базовые методы CRUD для работы с Firestore (create, read, update, delete)
   - Добавить поддержку транзакций и пакетных операций
   - Реализовать методы для работы с подколлекциями
   - Добавить поддержку пагинации для больших коллекций
   - Реализовать систему кэширования для оптимизации запросов

2. Разработать `FirebaseStorageService` для работы с файлами:
   - Создать методы для загрузки и скачивания файлов
   - Реализовать отслеживание прогресса загрузки/скачивания
   - Добавить поддержку возобновляемых загрузок
   - Реализовать кэширование часто используемых файлов

3. Создать `QueryBuilder` для формирования сложных запросов:
   - Реализовать fluent-интерфейс для построения запросов
   - Добавить поддержку фильтрации, сортировки и ограничения результатов
   - Реализовать методы для агрегирования данных

4. Разработать систему кэширования данных:
   - Создать `CacheManager` для управления кэшем
   - Реализовать стратегию инвалидации кэша
   - Добавить поддержку TTL (Time-To-Live) для кэшированных данных
   - Обеспечить консистентность кэша при обновлении данных

5. Настроить провайдеры Riverpod для доступа к сервисам:
   - Создать провайдер для `FirestoreDataService`
   - Реализовать провайдер для `FirebaseStorageService`
   - Добавить провайдер для `CacheManager`

## Технические требования
- Следуй принципам чистой архитектуры и инъекции зависимостей
- Используй Riverpod для предоставления сервисов через провайдеры
- Реализуй единообразную обработку ошибок с использованием `ErrorHandler` из задачи 1.2
- Сервисы должны быть тестируемыми и иметь четкие интерфейсы
- Оптимизируй запросы к Firestore, используя кэширование и пагинацию
- Обеспечь обработку офлайн-режима и синхронизацию данных
- Используй транзакции для обеспечения целостности данных при связанных операциях
- Документируй каждый публичный метод и класс
- Логируй важные операции с использованием сервиса логирования из задачи 1.2

## Связи с другими задачами
- **Зависит от:** Задача 1.1 (Инициализация проекта), Задача 1.2 (Базовые сервисы), Задача 1.4 (Доменные модели и интерфейсы)
- **Влияет на:** Все последующие задачи, связанные с доступом к данным (практически все задачи, начиная с Фазы 2)

## Критерии готовности
- Реализован базовый `FirestoreDataService` с методами CRUD
- Создан `FirebaseStorageService` для работы с файлами
- Реализована система кэширования данных с управлением инвалидацией
- Добавлена поддержка пагинации для больших коллекций
- Настроены провайдеры Riverpod для всех сервисов
- Сервисы корректно обрабатывают ошибки и офлайн-режим
- Код имеет достаточное документирование
- Сервисы оптимизированы для минимизации запросов к Firestore

## Примечания
- Используй Firestore SDK эффективно, минимизируя количество запросов
- Обрати внимание на ограничения Firestore и Firebase Storage
- Для кэширования используй in-memory кэш для быстрого доступа и persistent кэш для долгосрочного хранения
- Учитывай ограничения веб-платформы при работе с файлами
- Рассмотри возможность использования Firebase Emulator для локального тестирования
- Учитывай рекомендации по денормализации данных для оптимизации чтения

## Завершение
После выполнения задачи добавь в файл `status.md` запись о выполненной работе в следующем формате:

Задача 1.5: Настройка базового DataService
* Статус: Выполнено
* Дата: [Текущая дата]
* Выполненные шаги:
    * Реализован FirestoreDataService для централизованного доступа к данным
    * Создан FirebaseStorageService для работы с файлами
    * Разработана система кэширования данных
    * Добавлена поддержка пагинации и оптимизированных запросов
    * Настроены провайдеры Riverpod для всех сервисов
* Созданные файлы:
    * src/infrastructure/services/firestore_data_service.dart - сервис для работы с Firestore
    * src/infrastructure/services/firebase_storage_service.dart - сервис для работы с файлами
    * src/infrastructure/services/cache_manager.dart - менеджер кэширования
    * src/infrastructure/utils/query_builder.dart - построитель запросов
    * src/infrastructure/providers/data_providers.dart - провайдеры для сервисов
* Проблемы и решения:
    * [Если были проблемы, описание проблем и их решений]