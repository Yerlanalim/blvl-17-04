# Задача 7.4: Интеграция с контролем доступа

## Подготовка
- Внимательно изучи документы `bizlevel-concept-updated.md` и `status.md` для полного понимания архитектуры проекта и текущего статуса разработки.
- Ознакомься с реализацией из Фаз 1-6 и задач 7.1-7.3, особенно с `SubscriptionManager` и системой контента.
- Изучи особенности работы с контролем доступа к премиум-контенту и разграничением прав.

## Описание задачи
Требуется связать систему подписки с контролем доступа к премиум-контенту на карте уровней и в других частях приложения. Необходимо обеспечить проверку статуса подписки для предоставления или ограничения доступа к определенным функциям и контенту, а также реализовать визуальные индикаторы премиум-статуса и механизмы привлечения внимания к платному контенту.

Шаги:
1. Создать централизованный сервис контроля доступа в директории `src/application/services/`:
   - Разработать класс `AccessControlService` для централизованной проверки прав доступа
   - Реализовать интеграцию с `SubscriptionManager` для проверки статуса подписки
   - Добавить кэширование результатов проверки для оптимизации производительности
   - Реализовать различные уровни доступа (бесплатный, премиум, различные планы подписки)
   - Создать механизм обновления прав доступа при изменении статуса подписки

2. Интегрировать контроль доступа с картой уровней:
   - Обновить `LevelMapManager` для учета премиум-статуса уровней
   - Реализовать фильтрацию и отображение премиум-уровней в зависимости от подписки
   - Добавить визуальные индикаторы премиум-контента на карте уровней
   - Создать механизм блокировки и разблокировки уровней при изменении статуса подписки
   - Реализовать интерактивные подсказки для получения доступа к премиум-контенту

3. Интегрировать контроль доступа с системой контента:
   - Обновить сервисы `VideoService`, `TestEngine` и `ArtifactsManager` для проверки прав доступа
   - Реализовать фильтрацию премиум-контента в списках и результатах поиска
   - Добавить обработку попыток доступа к премиум-контенту без подписки
   - Создать механизм показа превью премиум-контента для привлечения внимания
   - Реализовать обработку случаев истечения подписки во время работы с контентом

4. Разработать UI компоненты для отображения премиум-статуса:
   - Создать виджет `PremiumBadge` для маркировки премиум-контента
   - Реализовать виджет `PremiumContentPreview` для предпросмотра премиум-контента
   - Добавить виджет `SubscriptionUpsellDialog` для предложения подписки
   - Создать виджет `PremiumContentLock` для визуализации заблокированного контента
   - Реализовать анимации для привлечения внимания к премиум-возможностям

5. Создать механизмы для аналитики и оценки эффективности:
   - Разработать систему для отслеживания попыток доступа к премиум-контенту
   - Реализовать сбор статистики по конверсии из бесплатных пользователей в платных
   - Добавить механизм для анализа наиболее востребованного премиум-контента
   - Создать инструменты для оценки эффективности различных методов привлечения к подписке

6. Настроить провайдеры Riverpod для управления доступом:
   - Создать провайдер для `AccessControlService`
   - Реализовать провайдеры для проверки доступа к различным типам контента
   - Добавить провайдеры для отслеживания изменений прав доступа
   - Обеспечить обновление UI при изменении статуса подписки

## Технические требования
- Следуй принципам чистой архитектуры и разделения ответственности
- Используй Riverpod для управления состоянием и зависимостями
- Реализуй эффективный механизм кэширования результатов проверки доступа
- Обеспечь централизованный контроль доступа для всего приложения
- Используй шаблон "Декоратор" для добавления проверки доступа к существующим сервисам
- Реализуй механизм обновления прав доступа в реальном времени при изменении подписки
- Обеспечь корректную обработку граничных случаев (истечение подписки во время сессии)
- Используй Firebase Security Rules для обеспечения защиты на уровне базы данных
- Реализуй систему логирования для аудита доступа к премиум-контенту

## Связи с другими задачами
- **Зависит от:** Задача 3.2 (LevelMapManager), Задача 4.1 (VideoService), Задача 4.2 (TestEngine), Задача 4.3 (ArtifactsManager), Задача 7.1 (SubscriptionManager)
- **Влияет на:** Задача 7.5 (Комплексное тестирование приложения), Задача 7.6 (Оптимизация производительности)

## Критерии готовности
- Создан централизованный сервис контроля доступа
- Реализована интеграция с картой уровней и системой контента
- Разработаны UI компоненты для отображения премиум-статуса
- Созданы механизмы для аналитики и оценки эффективности
- Настроены провайдеры Riverpod для управления доступом
- Система корректно обрабатывает изменения статуса подписки
- Реализованы визуальные индикаторы премиум-контента
- Обеспечена безопасность доступа на уровне клиента и базы данных
- Код имеет достаточное документирование

## Примечания
- Контроль доступа является критически важным для бизнес-модели приложения, поэтому уделите особое внимание надежности и безопасности
- Баланс между бесплатным и платным контентом должен быть тщательно продуман для мотивации пользователей к подписке
- Рассмотрите возможность временного доступа к премиум-контенту (пробный период, реварды) для привлечения пользователей
- Визуальные индикаторы премиум-контента должны привлекать внимание, но не быть навязчивыми
- Предусмотрите механизмы для мягкого перенаправления пользователей на экран подписки при попытке доступа к премиум-контенту
- Рассмотрите возможность частичного доступа к премиум-контенту для повышения привлекательности
- Обеспечьте корректную обработку случаев изменения статуса подписки во время активной сессии
- Предусмотрите механизмы для сохранения прогресса по премиум-контенту даже после окончания подписки

## Завершение
После выполнения задачи добавь в файл `status.md` запись о выполненной работе в следующем формате:

Задача 7.4: Интеграция с контролем доступа
* Статус: Выполнено
* Дата: [Текущая дата]
* Выполненные шаги:
    * Создан централизованный сервис контроля доступа
    * Реализована интеграция с картой уровней
    * Обновлены сервисы контента для проверки прав доступа
    * Разработаны UI компоненты для отображения премиум-статуса
    * Созданы механизмы для аналитики и оценки эффективности
    * Настроены провайдеры Riverpod для управления доступом
* Созданные файлы:
    * src/application/services/access_control_service.dart - сервис контроля доступа
    * src/application/services/premium_content_manager.dart - менеджер премиум-контента
    * src/features/level_map/presentation/widgets/premium_level_indicator.dart - индикатор премиум-уровня
    * src/features/payment/presentation/widgets/premium_badge.dart - значок премиум-контента
    * src/features/payment/presentation/widgets/premium_content_preview.dart - предпросмотр премиум-контента
    * src/features/payment/presentation/dialogs/subscription_upsell_dialog.dart - диалог предложения подписки
    * src/features/payment/presentation/widgets/premium_content_lock.dart - блокировка премиум-контента
    * src/application/analytics/premium_content_analytics.dart - аналитика премиум-контента
    * src/application/providers/access_control_providers.dart - провайдеры для контроля доступа
* Проблемы и решения:
    * [Если были проблемы, описание проблем и их решений]