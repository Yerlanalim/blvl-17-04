# BizLevel: Концепция и архитектура приложения

## 1. Общее описание
BizLevel — образовательная платформа для предпринимателей с уровневой системой обучения в стиле Duolingo. Пользователи последовательно проходят уровни, разблокируя новые, просматривают видеоуроки, выполняют тесты и получают доступ к полезным материалам (артефактам).

**Целевая аудитория:** начинающие и действующие предприниматели, желающие структурированно изучить основы бизнеса

**Ключевые особенности:**
- Геймифицированная карта уровней с визуальной прогрессией
- Видеоконтент через интеграцию с YouTube/Vimeo
- Тесты для закрепления материала
- Артефакты (скачиваемые материалы)
- ИИ-ассистент "Лео" на базе Gemini API
- Профиль с визуализацией навыков в стиле RPG
- Система достижений
- Разделение на бесплатный и премиум-контент

## 2. Технический стек
- **Frontend:** Flutter (веб-первый подход)
- **Backend:** Firebase (Auth, Firestore, Storage, Functions)
- **Управление состоянием:** Riverpod
- **Навигация:** Go Router
- **Внешние API:** 
  - Gemini API (для ИИ-ассистента)
  - YouTube/Vimeo API (для встраивания видео)

**Основные зависимости:**
```
flutter: sdk: flutter
flutter_riverpod: ^2.5.1
riverpod_annotation: ^2.3.5
firebase_core: ^2.25.4
firebase_auth: ^4.17.4
cloud_firestore: ^4.15.4
firebase_storage: ^11.6.5
cloud_functions: ^4.6.5
go_router: ^14.2.1
http: ^1.2.2
```

## 3. Архитектурные принципы

### 3.1. Чистая архитектура и Feature-First структура

Проект организован в соответствии с принципами чистой архитектуры с явным разделением слоев:

1. **Domain Layer**
   - Модели данных и бизнес-сущности
   - Интерфейсы репозиториев (определяют контракты взаимодействия с данными)
   - Бизнес-правила и логика предметной области

2. **Application Layer**
   - Сервисы для координации бизнес-логики
   - Провайдеры состояния (Riverpod)
   - Контроллеры для взаимодействия с UI

3. **Infrastructure Layer**
   - Реализации репозиториев
   - Адаптеры для Firebase и других внешних сервисов
   - Вспомогательные классы для работы с данными

4. **Presentation Layer**
   - UI-компоненты и экраны
   - Адаптеры для форматирования данных для UI
   - Обработчики пользовательского ввода

### 3.2. Модульная структура

Проект организован по Feature-First принципу, где каждая функциональная область имеет свой собственный модуль:

```
lib/
├── src/
│   ├── core/                 # Общие компоненты
│   │   ├── constants/        # Константы (цвета, размеры, строки)
│   │   ├── theme/            # Настройки темы приложения
│   │   ├── utils/            # Вспомогательные функции
│   │   │   ├── error_handler.dart  # Централизованная обработка ошибок
│   │   │   ├── analytics.dart      # Аналитика и логирование
│   │   │   └── connectivity.dart   # Обработка сетевых соединений
│   │   └── widgets/          # Общие виджеты
│   │
│   ├── domain/               # Общие доменные модели и сервисы
│   │   ├── data_service.dart # Абстракция доступа к данным
│   │   └── app_config.dart   # Конфигурация приложения
│   │
│   ├── features/             # Функциональные модули
│   │   ├── auth/             # Аутентификация
│   │   ├── level_map/        # Карта уровней
│   │   ├── level_details/    # Содержимое уровня
│   │   ├── artifacts/        # Скачиваемые материалы
│   │   ├── profile/          # Профиль пользователя
│   │   ├── payment/          # Заглушка для kaspi.kz
│   │   └── ai_assistant/     # ИИ-ассистент "Лео"
│   │
│   └── routing/              # Навигация
│       ├── app_router.dart
│       └── router_notifier.dart
│
└── main.dart
```

### 3.3. Управление состоянием

Используется Riverpod для эффективного управления состоянием:

1. **Централизованное хранилище состояния**
   - Используются `@riverpod` аннотации для ясной структуры провайдеров
   - Применяется принцип атомарных состояний для минимизации перерисовок

2. **Оптимизация запросов к Firestore**
   - Использование `ref.watch()` и `ref.listen()` для эффективной реактивности
   - Кэширование результатов запросов с контролируемой инвалидацией

3. **Обработка асинхронных состояний**
   - Единообразный подход к обработке AsyncValue в UI
   - Централизованное управление ошибками и состояниями загрузки

### 3.4. Управление прогрессом пользователя

Централизованная система управления прогрессом:

1. **ProgressManager**
   - Единая точка для всех операций с прогрессом
   - Использование транзакций для обеспечения согласованности данных

2. **Модель агрегированного прогресса**
   - Компактное представление прогресса для оптимизации чтения/записи
   - Эффективная проверка условий завершения уровней

## 4. Схема данных Firestore

### 4.1. Коллекции и структура данных

```
users/                 # Пользователи
  {userId}/            # Документ пользователя
    profile: {         # Профиль пользователя
      displayName: string,
      photoUrl: string,
      businessInfo: {...},
      skills: {...},
      achievements: [...]
    }
    
progress/              # Отдельная подколлекция для прогресса
  {userId}/            # Отдельные документы для разных типов прогресса
    summary: {         # Агрегированная информация о прогрессе
      currentLevel: number,
      completedLevels: [1, 2, ...],
      totalVideosWatched: number,
      totalTestsCompleted: number,
      totalArtifactsDownloaded: number,
      lastUpdateTime: timestamp
    }
    
    level_{levelId}: { # Для каждого уровня отдельный документ
      videosWatched: ["video_id_1", ...],
      testsCompleted: {"test_1": 80, ...},
      artifactsDownloaded: ["artifact_1", ...],
      startedAt: timestamp,
      completedAt: timestamp,
      progressPercentage: number
    }

levels/                # Уровни
  {levelId}/           # Документ уровня
    title: string,
    description: string,
    order: number,
    isPremium: boolean,
    nextLevelId: string,
    contents: {        # Ссылки на содержимое уровня
      videoIds: [string],
      testIds: [string],
      artifactIds: [string]
    },
    skillsGained: {    # Навыки, получаемые за уровень
      personal: number,
      management: number,
      etc...
    }

level_connections/     # Связи между уровнями для карты
  {connectionId}/
    sourceLevelId: string,
    targetLevelId: string,
    direction: string

videos/                # Видео
  {videoId}/
    title: string,
    description: string,
    youtubeId: string,
    levelId: string,
    order: number,
    duration: number

tests/                 # Тесты
  {testId}/
    title: string,
    description: string,
    levelId: string,
    videoId: string,    # Связанное видео
    passingScore: number,
    questions: [...]    # Вложенные вопросы или ссылки на коллекцию вопросов

artifacts/             # Артефакты (материалы)
  {artifactId}/
    title: string,
    description: string,
    fileUrl: string,
    fileType: string,
    levelId: string

chats/                 # Диалоги с ИИ
  {userId}/            # По пользователям
    sessions/
      {sessionId}/     # Сессии чата
        title: string,
        createdAt: timestamp,
        messages: [...]
```

### 4.2. Оптимизация запросов

1. **Индексы и запросы**
   - Созданы композитные индексы для основных запросов
   - Использование постраничной загрузки для больших коллекций

2. **Агрегация данных**
   - Критические данные дублируются для минимизации запросов
   - Сводные документы для быстрого доступа к статистике

3. **Денормализация для эффективности**
   - Копии часто используемых данных для уменьшения связанных запросов
   - Соблюдение баланса между нормализацией и производительностью

## 5. Ключевые подсистемы

### 5.1. Система аутентификации

1. **AuthService**
   - Централизованное управление аутентификацией
   - Поддержка email/password и Google Sign-In
   - Создание профиля и начального прогресса при регистрации

2. **Защита данных**
   - Правила безопасности Firestore для контроля доступа
   - Проверка прав на уровне приложения и базы данных

### 5.2. Система карты уровней

1. **LevelMapManager**
   - Загрузка и отображение уровней с оптимизированной производительностью
   - Пагинация и кэширование для больших наборов уровней

2. **ProgressTracker**
   - Отслеживание завершенных элементов контента
   - Визуализация прогресса на карте уровней

### 5.3. Система видео и тестов

1. **VideoPlayerService**
   - Интеграция с YouTube/Vimeo через iframe
   - Отслеживание прогресса и состояния просмотра

2. **TestEngineService**
   - Управление процессом тестирования
   - Оценка и сохранение результатов

### 5.4. Система ИИ-ассистента

1. **AIAssistantService**
   - Управление диалогами с Gemini API
   - Контекстная персонализация на основе прогресса пользователя

2. **ContextBuilder**
   - Формирование релевантного контекста для ИИ
   - Оптимизация запросов с кэшированием частых вопросов

### 5.5. Система управления артефактами

1. **ArtifactsManager**
   - Контроль загрузки и отображения артефактов
   - Отслеживание скачиваний и связь с прогрессом

2. **FileDownloadService**
   - Управление загрузками с возобновлением
   - Отслеживание состояния загрузки

### 5.6. Система платежей (заглушка)

1. **SubscriptionManager**
   - Управление статусом подписки
   - Контроль доступа к премиум-контенту

2. **MockPaymentService**
   - Имитация процесса оплаты для тестирования

## 6. Подход к обработке ошибок

1. **Централизованный ErrorHandler**
   - Единый интерфейс для обработки ошибок
   - Форматирование дружественных сообщений для пользователя

2. **Стратегия восстановления**
   - Автоматические повторные попытки для временных ошибок
   - Сохранение состояния для восстановления после сбоев

3. **Логирование и аналитика**
   - Структурированное логирование ошибок
   - Агрегация типичных проблем для их устранения

## 7. Стратегия тестирования

1. **Юнит-тесты для бизнес-логики**
   - Тестирование логики прогресса и условий разблокировки
   - Проверка преобразований данных и валидации

2. **Виджет-тесты для UI**
   - Изолированное тестирование компонентов
   - Проверка отображения различных состояний

3. **Интеграционные тесты**
   - Тестирование взаимодействия между модулями
   - Проверка потоков данных между экранами

4. **Firebase Emulator**
   - Локальное тестирование интеграции с Firebase
   - Имитация различных состояний базы данных

## 8. Стратегия масштабирования

1. **Горизонтальное масштабирование**
   - Возможность добавления новых типов контента
   - Расширение структуры уровней без изменения кода

2. **Оптимизация производительности**
   - Прогрессивная загрузка контента
   - Динамическое кэширование часто используемых данных

3. **Интернационализация**
   - Поддержка нескольких языков через структуру локализации
   - Культурные адаптации содержимого

## 9. Процесс развертывания

1. **CI/CD конвейер**
   - Автоматическая сборка и развертывание через GitHub Actions
   - Проверка качества кода и тестирование

2. **Firebase Hosting**
   - Оптимизированное развертывание веб-версии
   - Настройка кэширования для статических ресурсов

3. **Контроль версий**
   - Семантическое версионирование релизов
   - Механизм принудительного обновления при критических изменениях
