# Задача 4.2: Разработка TestEngine

## Подготовка
- Внимательно изучи документы `bizlevel-concept-updated.md` и `status.md` для полного понимания архитектуры проекта и текущего статуса разработки.
- Ознакомься с реализацией из Фаз 1-3 и Задачи 4.1 (VideoService).
- Изучи структуру данных Firestore для коллекции `tests` и связанных с ней `questions`.

## Описание задачи
Требуется разработать движок для управления тестами (TestEngine), включая логику проверки ответов, подсчета результатов и обновления прогресса пользователя. Система должна поддерживать различные типы вопросов, валидацию ответов и сохранение результатов.

Шаги:
1. Создать репозиторий для работы с тестами в директории `src/infrastructure/repositories/`:
   - Имплементировать интерфейс `ITestRepository` для взаимодействия с Firestore
   - Реализовать методы для получения тестов по ID, по уровню и по связанному видео
   - Добавить методы для загрузки вопросов теста с оптимизацией запросов
   - Реализовать кэширование данных для оффлайн-режима

2. Разработать основные компоненты TestEngine в директории `src/application/services/`:
   - Создать класс `TestEngine` для управления процессом тестирования
   - Реализовать класс `TestScorer` для подсчета и оценки результатов
   - Добавить класс `AnswerValidator` для проверки ответов различных типов
   - Создать класс `TestSessionManager` для управления сессиями тестирования

3. Реализовать логику работы с различными типами вопросов:
   - Добавить поддержку вопросов с одним правильным ответом
   - Реализовать обработку вопросов с несколькими правильными ответами
   - Добавить поддержку вопросов с вводом текста
   - Реализовать соответствие (matching) элементов
   - Добавить поддержку вопросов "верно/неверно"

4. Интегрировать TestEngine с системой прогресса:
   - Создать механизм сохранения результатов тестов в прогрессе пользователя
   - Реализовать логику определения прохождения теста (на основе passingScore)
   - Добавить механизм повторного прохождения тестов с сохранением лучшего результата
   - Интегрировать систему с `ProgressManager` для обновления общего прогресса

5. Настроить провайдеры Riverpod для управления состоянием тестов:
   - Создать провайдеры для `TestRepository` и `TestEngine`
   - Реализовать провайдеры для текущего теста и сессии тестирования
   - Добавить провайдеры для отслеживания прогресса прохождения теста
   - Создать провайдеры для истории результатов тестов

## Технические требования
- Следуй принципам чистой архитектуры и разделения ответственности
- Используй Riverpod для управления состоянием и зависимостями
- Реализуй систему, способную работать в оффлайн-режиме
- Используй атомарные операции Firestore для обновления результатов
- Обеспечь защиту от подделки результатов тестов
- Реализуй кэширование данных для быстрой загрузки тестов
- Обеспечь поддержку различных типов вопросов через единый интерфейс
- Реализуй механизм временных ограничений на прохождение теста (если указано)
- Используй транзакции для сохранения результатов, чтобы избежать потери данных

## Связи с другими задачами
- **Зависит от:** Задача 1.4 (Доменные модели и интерфейсы), Задача 1.5 (DataService), Задача 3.3 (ProgressManager), Задача 4.1 (VideoService)
- **Влияет на:** Задача 4.5 (UI для тестов), Задача 4.7 (Интеграция и тестирование системы контента)

## Критерии готовности
- Реализован `TestRepository` для работы с данными тестов
- Создан `TestEngine` с полной функциональностью обработки тестов
- Работает проверка ответов для всех типов вопросов
- Реализовано сохранение и загрузка результатов тестов
- Настроена интеграция с системой прогресса
- Тесты корректно работают в оффлайн-режиме
- Реализована система подсчета результатов
- Код имеет достаточное документирование

## Примечания
- Тщательно продумай структуру хранения различных типов вопросов и их валидацию
- Учитывай необходимость случайного порядка вопросов и вариантов ответов
- Для защиты от подделки результатов можно использовать серверную валидацию через Cloud Functions
- Обеспечь возможность частичного сохранения прогресса при прохождении длинных тестов
- Предусмотри механизм для показа правильных ответов после завершения теста (если разрешено)
- Рассмотри возможность аналитики наиболее сложных вопросов для будущей оптимизации
- Используй эффективную стратегию загрузки тестов с приоритизацией текущего вопроса
- Разработай механизм предотвращения повторного прохождения теста сразу после неудачной попытки (cooldown period)

## Завершение
После выполнения задачи добавь в файл `status.md` запись о выполненной работе в следующем формате:

Задача 4.2: Разработка TestEngine
* Статус: Выполнено
* Дата: [Текущая дата]
* Выполненные шаги:
    * Создан TestRepository для работы с данными тестов
    * Разработан TestEngine для управления процессом тестирования
    * Реализована поддержка различных типов вопросов
    * Добавлена интеграция с системой прогресса
    * Настроены провайдеры Riverpod для управления состоянием
* Созданные файлы:
    * src/infrastructure/repositories/firestore_test_repository.dart - репозиторий для тестов
    * src/application/services/test_engine.dart - движок для управления тестами
    * src/application/services/test_scorer.dart - подсчет и оценка результатов
    * src/application/services/answer_validator.dart - валидация ответов
    * src/application/services/test_session_manager.dart - управление сессиями
    * src/application/providers/test_providers.dart - провайдеры для тестов
    * src/domain/models/test_session.dart - модель сессии тестирования
    * src/domain/models/question_types/* - модели различных типов вопросов
    * [Другие созданные файлы]
* Проблемы и решения:
    * [Если были проблемы, описание проблем и их решений]