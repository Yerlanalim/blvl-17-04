# Задача 4.1: Реализация VideoService

## Подготовка
- Внимательно изучи документы `bizlevel-concept-updated.md` и `status.md` для полного понимания архитектуры проекта и текущего статуса разработки.
- Ознакомься с реализацией из Фаз 1-3, особенно с `DataService`, `ProgressManager` и доменными моделями видео.
- Изучи особенности работы с YouTube/Vimeo API для встраивания видео.

## Описание задачи
Требуется создать сервис для работы с видеоконтентом, включая интеграцию с YouTube/Vimeo и отслеживание прогресса просмотра. Сервис должен обеспечивать эффективную загрузку, воспроизведение и контроль за просмотром видео в рамках учебных уровней.

Шаги:
1. Создать репозиторий для работы с видео в директории `src/infrastructure/repositories/`:
   - Имплементировать интерфейс `IVideoRepository` для взаимодействия с Firestore
   - Реализовать методы для получения видео по ID, по уровню и с фильтрацией
   - Добавить кэширование данных для оптимизации запросов
   - Реализовать методы для работы с метаданными видео (продолжительность, превью)

2. Разработать сервис `VideoService` в директории `src/application/services/`:
   - Имплементировать интерфейс `IVideoService` из задачи 1.4
   - Использовать `VideoRepository` для доступа к данным
   - Реализовать интеграцию с YouTube/Vimeo API для встраивания видео
   - Добавить обработку состояний воспроизведения (загрузка, буферизация, воспроизведение, ошибка)
   - Реализовать методы для взаимодействия с плеером (play, pause, seek)

3. Создать механизм отслеживания прогресса просмотра:
   - Разработать класс `VideoProgressTracker` для мониторинга просмотра
   - Реализовать логику определения завершения просмотра (например, 90% от длительности)
   - Добавить интеграцию с `ProgressManager` для обновления прогресса пользователя
   - Обеспечить корректное сохранение позиции просмотра для возможности продолжения

4. Настроить провайдеры Riverpod для управления состоянием видео:
   - Создать провайдер для `VideoService` и `VideoRepository`
   - Реализовать провайдер для текущего воспроизводимого видео
   - Добавить провайдеры для отслеживания состояния воспроизведения
   - Реализовать провайдер для сохранения истории просмотров

## Технические требования
- Следуй принципам чистой архитектуры и разделения ответственности
- Используй Riverpod для управления состоянием и зависимостями
- Реализуй поддержку как YouTube, так и Vimeo через единый интерфейс
- Используй iframe API для встраивания видео на веб-платформе
- Обеспечь корректную работу с сетевыми задержками и ошибками
- Реализуй оффлайн-режим с кэшированием метаданных видео
- Минимизируй потребление ресурсов при воспроизведении видео
- Обеспечь корректную обработку событий жизненного цикла приложения (пауза при свернутом приложении)
- Реализуй механизм для обработки ошибок воспроизведения

## Связи с другими задачами
- **Зависит от:** Задача 1.4 (Доменные модели и интерфейсы), Задача 1.5 (DataService), Задача 3.3 (ProgressManager)
- **Влияет на:** Задача 4.4 (UI для просмотра видео), Задача 4.2 (TestEngine), Задача 4.7 (Интеграция и тестирование системы контента)

## Критерии готовности
- Реализован `VideoRepository` для работы с данными видео
- Создан `VideoService` с интеграцией YouTube/Vimeo API
- Работает механизм отслеживания прогресса просмотра
- Настроены провайдеры Riverpod для управления состоянием
- Корректно обрабатываются все ошибки воспроизведения
- Реализовано сохранение позиции просмотра
- Видео корректно встраивается в приложение
- Код имеет достаточное документирование

## Примечания
- При работе с YouTube/Vimeo API учитывай ограничения и особенности каждой платформы
- Обрати внимание на обработку событий состояния видео (онлайн/оффлайн, буферизация)
- Для веб-версии используй iframe API, для мобильных платформ рассмотри нативные решения
- Учитывай возможные проблемы с воспроизведением видео в фоновом режиме на мобильных устройствах
- Рассмотри возможность предзагрузки метаданных и превью для улучшения UX
- Для определения завершения просмотра можно использовать различные метрики (процент просмотра, просмотр ключевых частей)
- При тестировании проверь работу с различными сценариями сетевых подключений
- Учитывай требования платформ по автовоспроизведению видео (обычно требуется взаимодействие пользователя)

## Завершение
После выполнения задачи добавь в файл `status.md` запись о выполненной работе в следующем формате:

Задача 4.1: Реализация VideoService
* Статус: Выполнено
* Дата: [Текущая дата]
* Выполненные шаги:
    * Создан VideoRepository для работы с данными видео
    * Реализован VideoService с интеграцией YouTube/Vimeo
    * Добавлен механизм отслеживания прогресса просмотра
    * Настроены провайдеры Riverpod для управления состоянием
    * Реализована обработка ошибок воспроизведения
* Созданные файлы:
    * src/infrastructure/repositories/firestore_video_repository.dart - репозиторий для работы с видео
    * src/application/services/video_service.dart - сервис для работы с видеоконтентом
    * src/application/services/video_progress_tracker.dart - отслеживание прогресса просмотра
    * src/application/providers/video_providers.dart - провайдеры для видео
    * src/infrastructure/models/video_playback_state.dart - модель состояния воспроизведения
    * [Другие созданные файлы]
* Проблемы и решения:
    * [Если были проблемы, описание проблем и их решений]