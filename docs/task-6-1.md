# Задача 6.1: Настройка Cloud Functions для Gemini API

## Подготовка
- Внимательно изучи документы `bizlevel-concept-updated.md` и `status.md` для полного понимания архитектуры проекта и текущего статуса разработки.
- Ознакомься с реализацией из Фаз 1-5, особенно с `DataService` и системой аутентификации.
- Изучи документацию Gemini API и особенности работы с Firebase Cloud Functions.

## Описание задачи
Требуется создать безопасную прослойку на Firebase Cloud Functions для взаимодействия с Gemini API, включая управление ключами API, обработку запросов и ответов, а также обеспечение безопасности доступа. Эта серверная часть будет служить мостом между клиентским приложением и API ИИ, защищая API-ключ и добавляя дополнительную логику обработки.

Шаги:
1. Настроить проект Firebase Cloud Functions:
   - Создать структуру проекта для Cloud Functions в директории `functions/`
   - Настроить TypeScript или JavaScript для разработки функций
   - Добавить необходимые зависимости для работы с Gemini API
   - Настроить конфигурацию окружения для хранения ключей и параметров

2. Разработать основную функцию для обработки запросов к Gemini API:
   - Создать HTTP-функцию `generateAIResponse` для проксирования запросов
   - Реализовать логику валидации входящих запросов
   - Добавить аутентификацию и авторизацию на основе Firebase Auth
   - Настроить обработку ошибок и логирование

3. Добавить дополнительные функции для управления контекстом ИИ:
   - Создать функцию `manageAIContext` для сохранения и обновления контекста диалога
   - Реализовать логику для ограничения размера контекста
   - Добавить возможность персонализации контекста на основе данных пользователя
   - Настроить кэширование частых запросов для оптимизации использования API

4. Разработать систему управления безопасностью:
   - Реализовать механизм проверки прав доступа на основе статуса подписки
   - Добавить защиту от злоупотреблений (rate limiting)
   - Настроить логирование использования API для аналитики
   - Создать механизм ротации ключей API

5. Настроить интеграцию с Firestore для хранения истории диалогов:
   - Создать логику для сохранения диалогов в коллекцию `chats/{userId}/sessions/{sessionId}`
   - Реализовать функции для получения истории диалогов
   - Добавить механизм очистки старых диалогов
   - Обеспечить синхронизацию между несколькими устройствами пользователя

## Технические требования
- Используй Firebase Cloud Functions с Node.js и TypeScript
- Применяй принципы чистой архитектуры с разделением на слои
- Обеспечь безопасность API-ключа Gemini (не храни в клиентском коде)
- Реализуй эффективное управление контекстом диалога для поддержания диалога
- Используй Firebase Auth для аутентификации запросов
- Реализуй механизмы кэширования для оптимизации использования API
- Обеспечь обработку ошибок и восстановление после сбоев
- Добавь логирование для отладки и мониторинга использования
- Настрой CORS для работы с веб-клиентом
- Реализуй валидацию входящих данных для предотвращения инъекций

## Связи с другими задачами
- **Зависит от:** Задача 2.1 (Репозиторий аутентификации), Задача 2.2 (AuthService)
- **Влияет на:** Задача 6.2 (AIAssistantService), Задача 6.4 (UI для чата с ассистентом), Задача 6.6 (Тестирование и оптимизация ассистента)

## Критерии готовности
- Настроены и развернуты Firebase Cloud Functions
- Работает безопасное взаимодействие с Gemini API
- Реализован механизм управления контекстом диалога
- Настроена авторизация и проверка прав доступа
- Работает система ограничения запросов (rate limiting)
- Настроена интеграция с Firestore для хранения истории диалогов
- Функции успешно проходят базовое тестирование
- Добавлено логирование и мониторинг использования API
- Код имеет достаточное документирование

## Примечания
- Планируй структуру Cloud Functions с учетом возможного масштабирования
- Обрати внимание на права доступа в правилах безопасности Firestore
- Учитывай, что Gemini API может иметь ограничения на количество запросов и размер контекста
- Рассмотри возможность реализации очереди запросов при высокой нагрузке
- Для тестирования используй Firebase Emulator Suite
- Предусмотри механизм для обновления системных промптов без необходимости обновления кода
- Учитывай различные типы запросов (генерация текста, ответы на вопросы, создание контента) и их особенности
- Разработай механизм для передачи контекста обучения пользователя (прогресс, уровни, навыки) для более персонализированных ответов

## Завершение
После выполнения задачи добавь в файл `status.md` запись о выполненной работе в следующем формате:

Задача 6.1: Настройка Cloud Functions для Gemini API
* Статус: Выполнено
* Дата: [Текущая дата]
* Выполненные шаги:
    * Настроен проект Firebase Cloud Functions
    * Разработаны функции для работы с Gemini API
    * Реализована система управления контекстом
    * Настроена авторизация и безопасность
    * Добавлена интеграция с Firestore для истории диалогов
    * Настроено логирование и мониторинг
* Созданные файлы:
    * functions/src/index.ts - точка входа для Cloud Functions
    * functions/src/ai/generate-response.ts - основная функция для работы с Gemini API
    * functions/src/ai/context-manager.ts - управление контекстом диалога
    * functions/src/ai/chat-storage.ts - хранение истории диалогов
    * functions/src/middleware/auth.ts - middleware для авторизации
    * functions/src/middleware/rate-limit.ts - ограничение частоты запросов
    * functions/src/utils/error-handler.ts - обработка ошибок
    * functions/src/utils/logging.ts - утилиты для логирования
* Проблемы и решения:
    * [Если были проблемы, описание проблем и их решений]