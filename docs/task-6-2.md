# Задача 6.2: Реализация AIAssistantService

## Подготовка
- Внимательно изучи документы `bizlevel-concept-updated.md` и `status.md` для полного понимания архитектуры проекта и текущего статуса разработки.
- Ознакомься с реализацией из Фаз 1-5 и Задачи 6.1 (Cloud Functions для Gemini API).
- Изучи особенности работы с контекстно-зависимыми диалоговыми системами.

## Описание задачи
Требуется разработать сервис `AIAssistantService` для управления диалогами с ИИ, включая формирование контекста на основе данных пользователя, отправку запросов к Cloud Functions, обработку ответов и управление сессиями чата. Сервис должен обеспечивать персонализированное взаимодействие с ИИ-ассистентом "Лео" на основе прогресса пользователя.

Шаги:
1. Создать интерфейс `IAIAssistantService` в директории `src/domain/services/`:
   - Определить методы для создания новой сессии чата
   - Добавить методы для отправки сообщения и получения ответа
   - Реализовать методы для управления историей диалогов
   - Определить методы для персонализации диалога на основе данных пользователя
   - Добавить методы для получения подсказок и рекомендаций в контексте обучения

2. Реализовать класс `AIAssistantService` в директории `src/application/services/`:
   - Имплементировать интерфейс `IAIAssistantService`
   - Настроить взаимодействие с Firebase Cloud Functions из задачи 6.1
   - Реализовать формирование контекста диалога на основе прогресса пользователя
   - Добавить механизм управления сессиями чата
   - Обеспечить работу с Firestore для сохранения и загрузки истории диалогов

3. Создать вспомогательные компоненты:
   - Разработать класс `ContextBuilder` для формирования релевантного контекста ИИ
   - Реализовать класс `ChatSessionManager` для управления сессиями диалога
   - Добавить класс `AIResponseProcessor` для обработки и форматирования ответов
   - Создать класс `PersonalizationEngine` для адаптации ответов к уровню пользователя

4. Интегрировать AIAssistantService с системой прогресса и обучения:
   - Разработать механизмы получения информации о текущем уровне и прогрессе
   - Создать логику для связывания вопросов с релевантным учебным материалом
   - Реализовать персонализацию ответов на основе навыков пользователя
   - Добавить возможность получения рекомендаций по дальнейшему обучению

5. Настроить механизмы кэширования и оптимизации:
   - Реализовать кэширование частых вопросов и ответов
   - Добавить оптимизацию размера контекста для экономии токенов
   - Создать механизм предварительной загрузки релевантной информации
   - Обеспечить эффективную работу в условиях ограниченного соединения

6. Настроить провайдеры Riverpod для управления состоянием:
   - Создать провайдер для `AIAssistantService`
   - Реализовать провайдеры для текущей сессии чата
   - Добавить провайдеры для истории сообщений
   - Настроить провайдеры для управления состоянием отправки сообщений

## Технические требования
- Следуй принципам чистой архитектуры и разделения ответственности
- Используй Riverpod для управления состоянием и зависимостями
- Реализуй эффективную стратегию управления контекстом диалога
- Обеспечь обработку ошибок при взаимодействии с Cloud Functions
- Реализуй механизм восстановления сессии диалога после перезапуска приложения
- Используй Stream для реактивного обновления истории диалога
- Оптимизируй использование Gemini API с учетом ограничений на токены
- Обеспечь работу в оффлайн-режиме с локальным сохранением диалогов
- Реализуй логирование для отладки и анализа взаимодействия с ИИ

## Связи с другими задачами
- **Зависит от:** Задача 6.1 (Cloud Functions для Gemini API), Задача 3.3 (ProgressManager)
- **Влияет на:** Задача 6.3 (Кэширование и оптимизация запросов), Задача 6.4 (UI для чата с ассистентом), Задача 6.5 (Интеграция с системой прогресса)

## Критерии готовности
- Создан интерфейс `IAIAssistantService` с необходимыми методами
- Реализован `AIAssistantService` с полной функциональностью
- Работает формирование персонализированного контекста для диалогов
- Реализовано управление сессиями чата
- Настроена интеграция с Cloud Functions и Firestore
- Работает кэширование для оптимизации запросов
- Обеспечена обработка ошибок и восстановление после сбоев
- Настроены провайдеры Riverpod для управления состоянием
- Код имеет достаточное документирование

## Примечания
- Учитывай, что контекст диалога имеет ограничение по размеру, поэтому разработай стратегию для его оптимизации
- Обрати внимание на безопасность при формировании контекста и обработке ответов
- Рассмотри возможность использования разных "персоналий" ассистента в зависимости от уровня пользователя (начинающий, продвинутый)
- Предусмотри механизм для обработки нерелевантных запросов и направления пользователя к учебным материалам
- Используй механизм отложенной синхронизации для работы в условиях нестабильного соединения
- Обеспечь приватность данных пользователя при формировании контекста для ИИ
- Для персонализации ответов используй не только прогресс, но и предпочтения пользователя, историю взаимодействий
- Рассмотри возможность использования "системных сообщений" для определения тона и стиля ответов ассистента

## Завершение
После выполнения задачи добавь в файл `status.md` запись о выполненной работе в следующем формате:

Задача 6.2: Реализация AIAssistantService
* Статус: Выполнено
* Дата: [Текущая дата]
* Выполненные шаги:
    * Создан интерфейс IAIAssistantService
    * Реализован AIAssistantService для управления диалогами
    * Добавлены компоненты для формирования контекста
    * Настроена интеграция с системой прогресса
    * Реализовано кэширование и оптимизация запросов
    * Настроены провайдеры Riverpod для управления состоянием
* Созданные файлы:
    * src/domain/services/ai_assistant_service.dart - интерфейс сервиса ИИ-ассистента
    * src/application/services/ai_assistant_service_impl.dart - реализация сервиса
    * src/application/services/context_builder.dart - построитель контекста диалога
    * src/application/services/chat_session_manager.dart - управление сессиями чата
    * src/application/services/ai_response_processor.dart - обработка ответов ИИ
    * src/application/services/personalization_engine.dart - персонализация ответов
    * src/domain/models/chat_session.dart - модель сессии чата
    * src/domain/models/chat_message.dart - модель сообщения чата
    * src/application/providers/ai_assistant_providers.dart - провайдеры для ИИ-ассистента
* Проблемы и решения:
    * [Если были проблемы, описание проблем и их решений]