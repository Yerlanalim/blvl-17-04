# Задача 4.3: Создание ArtifactsManager

## Подготовка
- Внимательно изучи документы `bizlevel-concept-updated.md` и `status.md` для полного понимания архитектуры проекта и текущего статуса разработки.
- Ознакомься с реализацией из Фаз 1-3 и задач 4.1-4.2.
- Изучи структуру данных Firestore для коллекции `artifacts` и особенности работы с Firebase Storage.

## Описание задачи
Требуется разработать сервис для управления артефактами (скачиваемыми материалами), включая загрузку файлов, отслеживание скачиваний и интеграцию с системой прогресса пользователя. Система должна обеспечивать эффективный доступ к файлам, их кэширование и мониторинг использования.

Шаги:
1. Создать репозиторий для работы с артефактами в директории `src/infrastructure/repositories/`:
   - Имплементировать интерфейс `IArtifactRepository` для взаимодействия с Firestore
   - Реализовать методы для получения артефактов по ID, по уровню и с фильтрацией
   - Добавить методы для получения метаданных артефактов
   - Реализовать кэширование данных об артефактах для оффлайн-доступа

2. Разработать сервис для работы с файлами в директории `src/application/services/`:
   - Создать класс `FileDownloadService` для управления загрузками файлов
   - Реализовать поддержку возобновляемых загрузок при прерывании соединения
   - Добавить отслеживание прогресса загрузки
   - Реализовать кэширование загруженных файлов для повторного использования
   - Создать механизм для очистки кэша при необходимости

3. Разработать основной сервис управления артефактами:
   - Создать класс `ArtifactsManager` в директории `src/application/services/`
   - Объединить работу с `ArtifactRepository` и `FileDownloadService`
   - Реализовать логику отслеживания скачиваний и обновления прогресса
   - Добавить проверку доступности артефактов на основе прогресса пользователя
   - Реализовать управление локальными копиями артефактов

4. Интегрировать систему артефактов с системой прогресса:
   - Создать механизм фиксации скачивания артефакта в прогрессе пользователя
   - Реализовать логику разблокировки артефактов по мере прохождения уровней
   - Добавить механизм учета скачиваний в общей статистике пользователя
   - Интегрировать с `ProgressManager` для обновления общего прогресса

5. Настроить провайдеры Riverpod для управления состоянием артефактов:
   - Создать провайдеры для `ArtifactRepository` и `ArtifactsManager`
   - Реализовать провайдеры для отслеживания состояния загрузок
   - Добавить провайдеры для доступа к списку доступных артефактов
   - Создать провайдеры для истории скачиваний

## Технические требования
- Следуй принципам чистой архитектуры и разделения ответственности
- Используй Riverpod для управления состоянием и зависимостями
- Реализуй эффективную работу с Firebase Storage для загрузки файлов
- Используй библиотеку для работы с локальным хранилищем на разных платформах
- Обеспечь возможность возобновления прерванных загрузок
- Реализуй учет ограничений по хранилищу на мобильных устройствах
- Обеспечь работу с различными типами файлов (PDF, DOCX, XLSX, и т.д.)
- Используй Stream для отслеживания прогресса загрузки
- Реализуй механизм проверки целостности загруженных файлов

## Связи с другими задачами
- **Зависит от:** Задача 1.4 (Доменные модели и интерфейсы), Задача 1.5 (DataService), Задача 3.3 (ProgressManager)
- **Влияет на:** Задача 4.6 (UI для артефактов), Задача 4.7 (Интеграция и тестирование системы контента)

## Критерии готовности
- Реализован `ArtifactRepository` для работы с данными артефактов
- Создан `FileDownloadService` для управления загрузками файлов
- Разработан `ArtifactsManager` для централизованного управления артефактами
- Работает отслеживание скачиваний и обновление прогресса
- Реализована возможность возобновления загрузок
- Настроено кэширование файлов для повторного использования
- Обеспечена интеграция с системой прогресса
- Код имеет достаточное документирование

## Примечания
- При работе с Firebase Storage учитывай особенности контроля доступа (security rules)
- Для мобильных платформ важно следить за использованием локального хранилища и предусмотреть механизм очистки
- Рассмотри возможность сжатия файлов для уменьшения объема загрузки на мобильных устройствах
- Используй механизм хэширования для проверки целостности загруженных файлов
- Предусмотри обработку различных ошибок при загрузке (нет соединения, недостаточно места, и т.д.)
- Разработай механизм для управления очередью загрузок при одновременном скачивании нескольких файлов
- Обеспечь поддержку различных типов подключения (WiFi/мобильные данные) с возможностью настройки ограничений
- Рассмотри возможность предварительного просмотра файлов перед загрузкой (если поддерживается)

## Завершение
После выполнения задачи добавь в файл `status.md` запись о выполненной работе в следующем формате:

Задача 4.3: Создание ArtifactsManager
* Статус: Выполнено
* Дата: [Текущая дата]
* Выполненные шаги:
    * Создан ArtifactRepository для работы с данными артефактов
    * Разработан FileDownloadService для управления загрузками
    * Реализован ArtifactsManager для централизованного управления
    * Добавлена интеграция с системой прогресса
    * Настроено кэширование и возобновление загрузок
    * Настроены провайдеры Riverpod для управления состоянием
* Созданные файлы:
    * src/infrastructure/repositories/firestore_artifact_repository.dart - репозиторий для артефактов
    * src/application/services/file_download_service.dart - сервис загрузки файлов
    * src/application/services/artifacts_manager.dart - менеджер артефактов
    * src/application/providers/artifact_providers.dart - провайдеры для артефактов
    * src/domain/models/download_state.dart - модель состояния загрузки
    * src/infrastructure/services/local_storage_service.dart - сервис локального хранилища
    * [Другие созданные файлы]
* Проблемы и решения:
    * [Если были проблемы, описание проблем и их решений]